
shared:
    image: golang:1.17
    environment:
        GO111MODULE: on

jobs:
    main:
        environment:
            SD_SONAR_OPTS:  "-Dsonar.sources=./ -Dsonar.exclusions=**/*_test.go,**/vendor/** -Dsonar.tests=./ -Dsonar.test.inclusions=**/*_test.go -Dsonar.test.exclusions=**/vendor/** -Dsonar.go.coverage.reportPaths=${SD_ARTIFACTS_DIR}/coverage.out -Dsonar.go.tests.reportPaths=${SD_ARTIFACTS_DIR}/report.json"
        requires: [~commit, ~pr]
        steps:
            - goversion: go version
            - modverify: go mod verify
            - vet: go vet ./...
            - gofmt: (! gofmt -d . | grep '^')
            - test-setup: go install gotest.tools/gotestsum@latest
            - test: gotestsum --format testname --jsonfile ${SD_ARTIFACTS_DIR}/report.json -- -coverprofile=${SD_ARTIFACTS_DIR}/coverage.out ./...
            - build: go build -a -o $SD_ARTIFACTS_DIR/meta
            - test-shebang: |
                ln -s $SD_ARTIFACTS_DIR/meta ./meta-cli
                noargs="$(./test-shebang.lua)"
                if [ "$noargs" != $'hello world\n{}' ]; then
                  echo >&2 $"./test-shebang.lua yielded\n${noargs}"
                  exit 1
                fi
                args="$(./test-shebang.lua --flagarg argvalue)"
                if [ "$args" != $'hello world\n{ "--flagarg", "argvalue" }' ]; then
                  echo >&2 $"./test-shebang.lua --flagarg argvalue yielded\n${args}"
                  exit 1
                fi
    publish:
        requires: [main]
        steps:
            - setup-ci: git clone https://github.com/screwdriver-cd/toolbox.git ci
            - tag: ./ci/git-tag.sh
            - release: "curl -sL https://git.io/goreleaser | bash"
        secrets:
            # Pushing tags to Git
            - GIT_KEY
            # Pushing releases to GitHub
            - GITHUB_TOKEN
